name: AI Issue Support

on:
  workflow_call:
    inputs:
      project_id:
        required: true
        type: string
      event_name:
        required: true
        type: string
      issue_title:
        required: true
        type: string
      issue_body:
        required: false
        type: string
        default: ""
      issue_number:
        required: true
        type: number
      issue_labels:
        required: false
        type: string
        default: ""
      comment_body:
        required: false
        type: string
        default: ""
      comment_author:
        required: false
        type: string
        default: ""
    secrets:
      COPILOT_MCP_GITHUB_TOKEN:
        required: true
      APP_ID:
        required: true
      APP_PRIVATE_KEY:
        required: true

jobs:
  gate:
    runs-on: ubuntu-latest
    outputs:
      should_respond: ${{ steps.check.outputs.should_respond }}
    steps:
      - name: Check if bot should respond
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
          COMMENT_BODY: ${{ inputs.comment_body }}
        run: |
          if [ "${{ inputs.event_name }}" = "issues" ]; then
            echo "should_respond=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if echo "$COMMENT_BODY" | grep -qiE "@kangobot|/kangobot"; then
            echo "Bot was mentioned — responding"
            echo "should_respond=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          BOT_COMMENTED=$(gh api "/repos/${{ github.repository }}/issues/${{ inputs.issue_number }}/comments" \
            --jq '[.[] | select(.user.login == "kangobot[bot]" or .user.login == "github-actions[bot]")] | length')
          if [ "$BOT_COMMENTED" -gt "0" ]; then
            echo "should_respond=true" >> "$GITHUB_OUTPUT"
          else
            echo "Bot has not previously commented — skipping"
            echo "should_respond=false" >> "$GITHUB_OUTPUT"
          fi

  respond:
    needs: gate
    if: needs.gate.outputs.should_respond == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Generate app token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          repositories: ChatControl,Boss,CoreArena,Protect,Winter-Src,ai-support,foundation

      - name: Checkout project
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app_token.outputs.token }}
          path: main

      - name: Checkout Foundation
        uses: actions/checkout@v4
        with:
          repository: kangarko/foundation
          token: ${{ steps.app_token.outputs.token }}
          path: foundation

      - name: Checkout AI support
        uses: actions/checkout@v4
        with:
          repository: kangarko/ai-support
          token: ${{ steps.app_token.outputs.token }}
          path: ai-support

      - name: Fetch conversation history
        if: inputs.comment_body != ''
        env:
          GH_TOKEN: ${{ steps.app_token.outputs.token }}
        run: |
          gh api "/repos/${{ github.repository }}/issues/${{ inputs.issue_number }}/comments" \
            --paginate > conversation.json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Copilot CLI
        run: npm install -g @github/copilot

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: pip install -r ai-support/requirements.txt

      - name: Fix bundled CLI permissions
        run: chmod +x "$(python -c 'import copilot, os; print(os.path.join(os.path.dirname(copilot.__file__), "bin", "copilot"))')"

      - name: Analyze issue and generate response
        env:
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_MCP_GITHUB_TOKEN }}
          GITHUB_APP_TOKEN: ${{ steps.app_token.outputs.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PROJECT_ID: ${{ inputs.project_id }}
          ISSUE_TITLE: ${{ inputs.issue_title }}
          ISSUE_BODY: ${{ inputs.issue_body }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          ISSUE_LABELS: ${{ inputs.issue_labels }}
          COMMENT_BODY: ${{ inputs.comment_body }}
          COMMENT_AUTHOR: ${{ inputs.comment_author }}
        run: python ai-support/responder.py

      - name: Propose learned insights via draft PR
        if: "!cancelled()"
        continue-on-error: true
        env:
          GH_TOKEN: ${{ steps.app_token.outputs.token }}
          ISSUE_NUM: ${{ inputs.issue_number }}
          SOURCE_REPO: ${{ github.repository }}
        run: |
          cd ai-support
          git add insights/ 2>/dev/null || exit 0
          if git diff --cached --quiet; then
            echo "No insight changes"
            exit 0
          fi
          BRANCH="insights/${SOURCE_REPO##*/}-${ISSUE_NUM}"
          git config user.name "kangobot[bot]"
          git config user.email "2869176+kangobot[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git commit -m "Learn from ${SOURCE_REPO}#${ISSUE_NUM}"
          git push -f origin "$BRANCH"
          EXISTING_PR=$(gh pr list --repo kangarko/ai-support --head "$BRANCH" --json url --jq '.[0].url' 2>/dev/null || true)
          if [ -z "$EXISTING_PR" ]; then
            gh pr create \
              --repo kangarko/ai-support \
              --draft \
              --title "Insights from ${SOURCE_REPO}#${ISSUE_NUM}" \
              --body "Learned insights extracted from ${SOURCE_REPO}#${ISSUE_NUM}. Review before merging."
          fi
          echo "Proposed insights via draft PR"

      - name: Create fix PR if changes were proposed
        id: fix_pr
        continue-on-error: true
        env:
          GH_TOKEN: ${{ steps.app_token.outputs.token }}
          ISSUE_NUM: ${{ inputs.issue_number }}
          ISSUE_TITLE: ${{ inputs.issue_title }}
        run: |
          cd main
          git checkout -- .github/ 2>/dev/null || true
          git add -A
          if git diff --cached --quiet; then
            echo "No code changes proposed"
            exit 0
          fi

          BRANCH="fix/issue-${ISSUE_NUM}"

          git config user.name "kangobot[bot]"
          git config user.email "2869176+kangobot[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git commit -m "Proposed fix for #${ISSUE_NUM}"
          git push -f origin "$BRANCH"

          EXISTING_PR=$(gh pr list --repo "${{ github.repository }}" --head "$BRANCH" --json url --jq '.[0].url' 2>/dev/null || true)

          if [ -n "$EXISTING_PR" ]; then
            echo "pr_url=$EXISTING_PR" >> "$GITHUB_OUTPUT"
          else
            PR_URL=$(gh pr create \
              --repo "${{ github.repository }}" \
              --draft \
              --title "Fix #${ISSUE_NUM}: ${ISSUE_TITLE}" \
              --body-file ../pr_description.md \
              --head "$BRANCH")
            echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"
          fi

      - name: Append PR link to response
        if: steps.fix_pr.outputs.pr_url && hashFiles('response.md') != ''
        run: |
          printf '\n\n---\n:memo: **A draft fix has been proposed:** %s' "${{ steps.fix_pr.outputs.pr_url }}" >> response.md

      - name: Post response comment
        if: "!cancelled() && hashFiles('response.md') != ''"
        env:
          GH_TOKEN: ${{ steps.app_token.outputs.token }}
        run: |
          gh issue comment "${{ inputs.issue_number }}" \
            --repo "${{ github.repository }}" \
            --body-file response.md

      - name: Post failure diagnostic
        if: "failure() && !steps.fix_pr.outcome && hashFiles('failure.md') != ''"
        env:
          GH_TOKEN: ${{ steps.app_token.outputs.token }}
        run: |
          gh issue comment "${{ inputs.issue_number }}" \
            --repo "${{ github.repository }}" \
            --body-file failure.md
